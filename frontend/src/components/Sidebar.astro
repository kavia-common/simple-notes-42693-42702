---
/**
 * Sidebar.astro
 * Displays search, "new note" button, and list of notes.
 */
import type { Note } from "../lib/storage";
const { notes = [], selectedId = "", onSelectId = "onSelectId", onCreate = "onCreate", onSearch = "onSearch" } = Astro.props as {
  notes: Note[];
  selectedId: string;
  onSelectId: string;
  onCreate: string;
  onSearch: string;
};
---
<aside class="sidebar">
  <div class="top">
    <input id="search" class="search" type="search" placeholder="Search notes..." aria-label="Search notes"/>
    <button id="new" class="btn primary" aria-label="Create new note">+ New</button>
  </div>
  <ul class="list" id="list" role="listbox" aria-label="Notes">
    {notes.map((n) => (
      <li class={"item " + (n.id === selectedId ? "active" : "")} data-id={n.id} role="option" aria-selected={n.id === selectedId}>
        <div class="title">{n.title || "Untitled"}</div>
        <div class="meta">{new Date(n.updatedAt).toLocaleString()}</div>
      </li>
    ))}
  </ul>
</aside>

<style>
  .sidebar {
    background: var(--surface, #ffffff);
    border-right: 1px solid var(--border-color);
    width: 320px;
    min-width: 240px;
    max-width: 420px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
  }
  .top { display: flex; gap: 8px; }
  .search {
    flex: 1;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-color);
    outline: none;
  }
  .search:focus { border-color: #2563EB66; box-shadow: 0 0 0 3px #2563EB22; }
  .btn {
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid transparent;
    cursor: pointer;
    background: var(--card-bg);
    color: var(--text-color);
    transition: all .2s ease;
  }
  .btn.primary {
    background: linear-gradient(83deg, #2563EB 0%, #0ea5e9 100%);
    color: #fff;
    box-shadow: 0 2px 8px rgba(37, 99, 235, .25);
  }
  .btn.primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, .35); }
  .list {
    list-style: none;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; gap: 8px;
    overflow: auto;
  }
  .item {
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    cursor: pointer;
    transition: background .2s ease, border-color .2s ease, transform .05s ease;
  }
  .item:hover { background: var(--card-hover-bg); }
  .item.active {
    border-color: #2563EB66;
    background: linear-gradient(120deg, rgba(37,99,235,0.08), rgba(245,158,11,0.05));
  }
  .title { font-weight: 600; font-size: 14px; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .meta { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
  @media (max-width: 900px) {
    .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); }
  }
</style>

<script>
  const props = { onSelectId: "<?= onSelectId ?>", onCreate: "<?= onCreate ?>", onSearch: "<?= onSearch ?>" };
  function setup() {
    const list = document.getElementById("list");
    const search = document.getElementById("search");
    const add = document.getElementById("new");
    list?.addEventListener("click", (e) => {
      const li = (e.target as HTMLElement).closest("li");
      if (!li) return;
      const id = li.getAttribute("data-id");
      if (!id) return;
      window.dispatchEvent(new CustomEvent(props.onSelectId, { detail: { id } }));
    });
    add?.addEventListener("click", () => {
      window.dispatchEvent(new CustomEvent(props.onCreate));
    });
    let timer: number | undefined;
    search?.addEventListener("input", () => {
      clearTimeout(timer);
      timer = window.setTimeout(() => {
        window.dispatchEvent(new CustomEvent(props.onSearch, { detail: { q: (search as HTMLInputElement).value } }));
      }, 150);
    });
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setup);
  } else {
    setup();
  }
</script>
